const async = require('async');
const rp = require('request-promise');
const removeItem = require('remove-array-items');

const fbFeedListOption = { 
    method:'GET', 
    url:'https://graph.facebook.com/v6.0/2819705001436386/feed?access_token=EAAkWsUhEDOUBAACZCgvRIsAk1xObIjGv1N5k8uetplXTJh8kWIEYj65u2YkgQb8RaxGxn1y8Pk1h1oMbfDBTZAFGVf3vHuKCWdIaYsZBA51vD5sxIJNR27cXcfh8DxFBMiPdgh1lsZCtNfz7NbCjMBQIZCPF0eD2Syz40lxRqM1ReX2XmQftSOK3W2Cj9u2EZD'
}
const feedCnt = 10;

var retArr = new Array();
var objArr;

function custom_sort(a, b) {
    return new Date(b.created_time).getTime() - new Date(a.created_time).getTime();
}

function getFbFeedList() {
    rp(
        fbFeedListOption
    ).then(
        function (body) { 
            objArr = JSON.parse(body);
            var i=0;
		    for(var subKey=0;subKey<objArr["data"].length;subKey++){
                if("message" in objArr["data"][subKey] ){
                    // console.log("message" in objArr["data"][subKey]);
                    getFbFeed(objArr["data"][subKey]["id"], i);
                    i++;
                }
            }
            // console.log("fbFeed:"+retArr);
        }
    ).catch(function(err){
        // res.socket.destroy();
        throw err;
    })
}

async function getFbFeed(feedId, id) { 
    // console.log(feedId);
    rp(
        {
            method:'GET', 
            uri:'https://graph.facebook.com/v6.0/'+feedId+'?access_token=EAAkWsUhEDOUBAACZCgvRIsAk1xObIjGv1N5k8uetplXTJh8kWIEYj65u2YkgQb8RaxGxn1y8Pk1h1oMbfDBTZAFGVf3vHuKCWdIaYsZBA51vD5sxIJNR27cXcfh8DxFBMiPdgh1lsZCtNfz7NbCjMBQIZCPF0eD2Syz40lxRqM1ReX2XmQftSOK3W2Cj9u2EZD&fields=permalink_url,picture,message,updated_time,created_time, status_type' 
        }
    ).then(
        await function(body) { 
            // if(error){throw error;} 
            // console.error('error', error);
            // console.log('statusCode:', response && response.statusCode); 
            retArr[id] = JSON.parse(body);
        }
    ).catch(function(err){
        // res.socket.destroy();
        throw err;
    })
}

function getData(req, res){
    async.waterfall([
        function(callback) {
            callback(null, getFbFeedList());
        }
    ], function (err, result) {
        // res.writeHead(200, {'Cache-Control': 'public, max-age=31536000'});
        if(err){
            console.log('Error 발생');
            res.socket.destroy();
        }else {
            retArr.sort(custom_sort);
            for(var i=0;i<retArr.length;i++){
                if(i == feedCnt){
                    removeItem(retArr,i,retArr.length-(feedCnt-1));	
                    break;
                }else{
                    if("wall_post"==JSON.parse(JSON.stringify(retArr[i])).status_type || !(JSON.parse(JSON.stringify(retArr[i])).hasOwnProperty("permalink_url"))){
                        // console.log(JSON.parse(JSON.stringify(retArr[i])));
                        removeItem(retArr,i,1);
                    }
                    // console.log("$$$$$$$$");
                    // console.log(JSON.parse(JSON.stringify(retArr[i])).hasOwnProperty("message"));
                    // console.log("*****************")
                }
                
            }
            // console.log(JSON.stringify(retArr));
            // console.log(retArr.length);
            // res.render('index', {goldBuy:goldBuy, goldSell:goldSell, pegGram:pegGram, pesGram:pesGram, btc:btc, excRate:excRate, investRate:investRate, kospi:kospi, kosdaq:kosdaq,fbNews:retArr.
            var ret = {goldBuy:0, goldSell:0, pegDon:0, pesDon:0, btc:0, excRate:0, investRate:0, kospi:0, kosdaq:0, dji:0, nasdaq:0, wti:0, fbNews:retArr, pegGram:0, pesGram:0, dubai:0, eth:0};
        
		res.render('index', ret);
        }  // 7
    });
};

module.exports = getData;
